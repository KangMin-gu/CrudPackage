<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="au">
	
	<select id="list" parameterType="hashMap" resultType="hashMap">
		SELECT * FROM (
			SELECT A.USERNO,A.USERNAME,A.USERID
		,A.EMAIL,A.USERDUTY
		,CASE WHEN A.ISDELETE = 0 THEN '사용'
			  WHEN A.ISDELETE = 1 THEN '미사용' END AS ISDELETE_
		,CASE WHEN DATE_FORMAT(A.REGDATE,'%Y-%m-%d') = '1900-01-01' THEN ''
				ELSE DATE_FORMAT(A.REGDATE,'%Y-%m-%d') END AS REGDATE
		,A.MOBILE1,A.MOBILE2,A.MOBILE3
		,CASE WHEN DATE_FORMAT(A.ENTERDATE,'%Y-%m-%d') = '1900-01-01' THEN ''
				ELSE DATE_FORMAT(A.ENTERDATE,'%Y-%m-%d') END AS ENTERDATE
		, CONCAT(A.MOBILE1, A.MOBILE2, A.MOBILE3) AS MOBILE
		,@RNUM:=@RNUM + 1 AS ROWNUM
			FROM me800010 A, (SELECT @RNUM := 0) R
			WHERE A.SITEID = #{siteid}
			AND A.ISDELETE = 0
			<if test="username != null">
				AND A.USERNAME LIKE '%'+#{username}+'%'
			</if>
			<if test="mobile != null">
				AND A.MOBILE LIKE '%'+#{mobile}+'%'
			</if>
			<if test="userid != null">
				AND A.USERID LIKE '%'+#{userid}+'%'
			</if>
			<if test="isdelete != null">
				AND A.ISDELETE = #{isdelete}
			</if>
			<if test="strdate != null">
				AND DATE_FORMAT(REGDATE,'%Y-%m-%d') <![CDATA[>=]]> #{strdate}
			</if>
			<if test="enddate != null">
				AND DATE_FORMAT(REGDATE,'%Y-%m-%d') <![CDATA[<=]]> #{enddate}
			</if>
			
			ORDER BY A.USERNO DESC
			) X 
			<if test="endRowNum != null">
				WHERE X.ROWNUM Between #{startRowNum} and #{endRowNum}
			</if>
		
	</select>
		<select id="detail" parameterType="userDto" resultType="hashMap">
		SELECT 
		A.USERNO
		,A.USERNAME
		,A.USERID
		,A.EMAIL
		,A.USERDUTY
		,CHKROLE
		,CASE WHEN A.ISDELETE = 0 THEN '사용'
			  WHEN A.ISDELETE = 1 THEN '미사용' END AS ISDELETE_
		,ISDELETE
		,CASE WHEN A.CHKAUTH = 10 THEN '일반사용자'
			  WHEN A.CHKAUTH = 20 THEN '관리자사용자' END AS CHKAUTH_
		,CHKAUTH
		,CASE WHEN DATE_FORMAT(A.ENTERDATE,'%Y-%m-%d') = '1900-01-01' THEN ''
				ELSE DATE_FORMAT(A.ENTERDATE,'%Y-%m-%d') END AS ENTERDATE
		,A.MOBILE1
		,A.MOBILE2
		,A.MOBILE3
		, CONCAT(A.MOBILE1,'-',A.MOBILE2,'-',A.MOBILE3) AS MOBILE
		,A.TELNO1
		,A.TELNO2
		,A.TELNO3
		, CONCAT(A.TELNO1,'-',A.TELNO2,'-',A.TELNO3) AS TELNO
		,A.USERDESC
		,(SELECT SITENAME FROM ma900010 B WHERE B.SITEID = A.SITEID) AS SITENAME
			FROM me800010 A
			WHERE A.SITEID = #{siteid}
			AND A.USERNO = #{userno}
			
	</select>
	
	<select id="totalRows" parameterType="hashMap" resultType="int">
	SELECT count(*)
			FROM me800010
			WHERE SITEID = #{siteid}
			AND ISDELETE = 0
			<if test="username != null">
				AND USERNAME LIKE '%'+#{username}+'%'
			</if>
			<if test="mobile != null">
				AND MOBILE LIKE '%'+#{mobile}+'%'
			</if>
			<if test="userid != null">
				AND USERID LIKE '%'+#{userid}+'%'
			</if>
			<if test="isdelete != null">
				AND ISDELETE = #{isdelete}
			</if>
			<if test="strdate != null">
				AND REGDATE <![CDATA[>]]>=#{strdate}
			</if>
			<if test="enddate != null">
				AND REGDATE <![CDATA[<]]>=#{enddate}
			</if>
	</select>
	<select id="idcheck" parameterType="String" resultType="int">
		SELECT count(*)
			FROM me800010
			WHERE USERID = #{userid}
			
	</select>
	
	<insert id="insert" parameterType="userDto">
				
			INSERT INTO me800010
			(
				SITEID
				,USERNAME
				,USERID
				,USERPASSWORD
				,USERDESC
				,EMAIL
				,ENTERDATE
				,USERDUTY
				,MOBILE1
				,MOBILE2
				,MOBILE3
				,TELNO1
				,TELNO2
				,TELNO3
				,CHKAUTH
				,ISDELETE
				,REGDATE
				,REGUSER
				,EDTDATE
				,EDTUSER
			)VALUES(
			#{siteid}
			,#{username}
			,#{userid}
			,#{userpassword}
			,#{userdesc}
			,#{email}
			,#{enterdate}
			,#{userduty}
			,#{mobile1}
			,#{mobile2}
			,#{mobile3}
			,#{telno1}
			,#{telno2}
			,#{telno3}
			,#{chkauth}
			,0
			,NOW()
			,#{reguser}
			,NOW()
			,#{edtuser}
			)
		<selectKey keyProperty="userno"  resultType="integer" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
		
	<update id="update" parameterType="userDto">
		UPDATE me800010
			SET 
				USERPASSWORD = #{userpassword}
				<if test="userdesc != null">
				,USERDESC = #{userdesc}
				</if>
				,EMAIL = #{email}
				<if test="enterdate != null">
				,ENTERDATE = #{enterdate}
				</if>
				,USERDUTY = #{userduty}
				,MOBILE1 = #{mobile1}
				,MOBILE2 = #{mobile2}
				,MOBILE3 = #{mobile3}
				,TELNO1 = #{telno1}
				,TELNO2 = #{telno2}
				,TELNO3 = #{telno3}
				<if test="chkauth != null">
				,CHKAUTH = #{chkauth}
				</if>		
				,EDTDATE = NOW()
				,EDTUSER = #{edtuser}
			WHERE USERNO = #{userno}
	</update>
	
	<update id="delete" parameterType="userDto">
		UPDATE me800010
			SET
				ISDELETE = '1'
			WHERE USERNO = #{userno}
	</update>
	
	<select id="topList" parameterType="int" resultType="hashMap">
		SELECT TOP 5
		A.USERNO
		,A.USERNAME
		,A.USERID
		,A.EMAIL
		,A.USERDUTY
		,CASE WHEN A.ISDELETE = 0 THEN '사용'
			  WHEN A.ISDELETE = 1 THEN '미사용' END AS ISDELETE_
		,DATE_FORMAT(A.REGDATE,'%Y-%m-%d') AS REGDATE
		,A.EMAIL
		,A.MOBILE1
		,A.MOBILE2
		,A.MOBILE3
			FROM me800010 A
			WHERE A.ISDELETE = 0
			AND A.SITEID = #{siteid}
	</select>
	
	<select id="menuList" parameterType="int" resultType="hashMap">
		SELECT X.MENUNO,X.MENUNAME
		,CASE WHEN X.CNT >= X.BUYCNT THEN 0 ELSE 1 END AS TOTAL
		,X.CNT,X.BUYCNT 
		FROM (SELECT B.MENUNO, B.MENUNAME, IFNULL(C.CNT, 0) AS CNT, A.BUYCNT
				FROM me810010 A
				INNER JOIN ma900030 B ON B.LICENSENO = A.LICENSENO
				LEFT OUTER JOIN (SELECT SITEID, COUNT(MENUNO) AS CNT, MENUNO
									FROM me810011
								GROUP BY MENUNO, SITEID, MENUNO) C ON C.MENUNO = B.MENUNO
				WHERE A.SITEID = #{siteid}) X
		WHERE CASE WHEN X.CNT <![CDATA[>=]]> X.BUYCNT THEN 0
				ELSE 1 END  != 0
	</select>
	
	<update id="menuDelete" parameterType="userMenuDto">
	
		UPDATE me810011
			SET ISDELETE = 1
			WHERE USERNO = #{userno}
			AND SITEID = #{siteid}
	</update>
	
	<insert id="menuMerge" parameterType="userMenuDto">
			INSERT INTO me810011   (SITEID,USERNO,MENUNO,REGDATE,REGUSER,EDTDATE,EDTUSER,ISDELETE)
							VALUES(#{siteid},#{userno},#{menuno},NOW(),#{reguser},NOW(),#{edtuser},0)
         ON DUPLICATE KEY UPDATE ISDELETE = 0 ;
	</insert>
	
	<select id="userMenu" parameterType="userMenuDto" resultType="hashMap">
		SELECT MENUNO FROM me810011
		WHERE SITEID = #{siteid}
		AND USERNO = #{userno}
	</select>
	<!-- 메일정보 얻어오기  -->
	<select id="adminMail" resultType="hashMap">
		<![CDATA[
		SELECT EMAIL,USERNAME,USERNO,SITEID,USERID FROM me800010
		WHERE EMAIL <> ' ' AND EMAIL IS NOT NULL
		]]> 
	</select>
	
</mapper>