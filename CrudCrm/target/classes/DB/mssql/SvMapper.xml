<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sv">

    <select id="list" parameterType="hashMap" resultType="hashMap">
    	SELECT * FROM (SELECT A.RCVNO
    		, A.RCVNAME
    		, CASE WHEN A.RCVTYPE = 1 THEN '문의'
    			   WHEN A.RCVTYPE = 2 THEN '개선'
    			   WHEN A.RCVTYPE = 3 THEN '오류' END AS RCVTYPE_
    		, A.RCVTYPE
    		, CASE WHEN A.PRCSTATE = 1 THEN '접수'
    			   WHEN A.PRCSTATE = 2 THEN '처리'
    			   WHEN A.PRCSTATE = 3 THEN '이관' END AS PRCSTATE_
    		, CASE WHEN B.RACTCODE = 1 THEN '처리유형1'
    			   WHEN B.RACTCODE = 2 THEN '처리유형2'
    			   WHEN B.RACTCODE = 3 THEN '처리유형3' END AS RACTCODE_
    		, CASE WHEN A.RCVCHANNEL = 10 THEN '전화' 
    			   WHEN A.RCVCHANNEL = 20 THEN 'SMS'
    			   WHEN A.RCVCHANNEL = 30 THEN '메일' END AS RCVCHANNEL_
    		, C.CUSTNAME AS CUSTNO_
    		, D.CLINAME AS CLINO_
    		, CONVERT(nvarchar,A.RCVDATE,23) AS RCVDATE_
    		, (SELECT USERNAME FROM Crud_SaaS.dbo.TB980010 WHERE USERNO = A.RCVOWNER) AS RCVOWNER_
    		, (SELECT USERNAME FROM Crud_SaaS.dbo.TB980010 WHERE USERNO = B.RACTOWNER) AS RACTOWNER_
    		, ROW_NUMBER() OVER (ORDER BY A.RCVNO DESC)             AS ROWNUM
    		 FROM Crud_SaaS.dbo.T_RCV A
    		 LEFT OUTER JOIN (SELECT TOP 1 * FROM Crud_SaaS.dbo.T_RACT ORDER BY RACTNO DESC) B ON B.RCVNO = A.RCVNO
    		 LEFT OUTER JOIN Crud_SaaS.dbo.CU100010 C ON C.CUSTNO = A.CUSTNO 
    		 LEFT OUTER JOIN Monarch_SaaS.dbo.TB200010 D ON D.CLIID = A.CLINO
    		 WHERE A.SITEID = #{siteid}
    		 AND A.ISDELETE = 0
 			<if test="strDate != null">
				AND A.RCVDATE <![CDATA[>]]>= #{strDate}
			</if>
			<if test="endDate != null">
				AND A.RCVDATE <![CDATA[<]]>= #{endDate}
			</if>
			<if test="custno != null">
				AND A.CUSTNO = #{custno}
			</if>
			<if test="rcvname != null">
				AND A.RCVNAME = #{rcvname}
			</if>
			<if test="rcvtype != null">
				AND A.RCVTYPE = #{rcvtype}
			</if>
			<if test="clino != null">
				AND A.CLINO = #{clino}
			</if>
			<if test="rcvchannel != null">
				AND A.RCVCHANNEL = #{rcvchannel}
			</if>
			<if test="rcvowner != null">
				AND A.RCVOWNER = #{rcvowner}
			</if>
			<if test="ractowner != null">
				AND B.RACTOWNER = #{ractowner}
			</if>
			<if test="prcstate != null">
				AND A.PRCSTATE = #{prcstate}
			</if>
    		 ) X
    		 <if test="endRowNum != null">
				WHERE X.ROWNUM Between #{startRowNum} and #{endRowNum}
			</if> 
    	

    </select>
	
	<select id="totalRows" parameterType="String" resultType="int">
		SELECT count(*) from Crud_SaaS.dbo.T_RCV A 
		LEFT OUTER JOIN (SELECT TOP 1 * FROM Crud_SaaS.dbo.T_RACT ORDER BY RACTNO DESC) B ON B.RCVNO = A.RCVNO
		WHERE A.SITEID = #{siteid}
		AND A.ISDELETE = 0
			<if test="strDate != null">
				AND A.RCVDATE <![CDATA[>]]>= #{strDate}
			</if>
			<if test="endDate != null">
				AND A.RCVDATE <![CDATA[<]]>= #{endDate}
			</if>
			<if test="custno != null">
				AND A.CUSTNO = #{custno}
			</if>
			<if test="rcvname != null">
				AND A.RCVNAME = #{rcvname}
			</if>
			<if test="rcvtype != null">
				AND A.RCVTYPE = #{rcvtype}
			</if>
			<if test="clino != null">
				AND A.CLINO = #{clino}
			</if>
			<if test="rcvchannel != null">
				AND A.RCVCHANNEL = #{rcvchannel}
			</if>
			<if test="rcvowner != null">
				AND A.RCVOWNER = #{rcvowner}
			</if>
			<if test="ractowner != null">
				AND B.RACTOWNER = #{ractowner}
			</if>
			<if test="prcstate != null">
				AND A.PRCSTATE = #{prcstate}
			</if>	
	</select>
	
	<select id ="detail" parameterType="rcvDto" resultType ="hashMap">
		SELECT
		C.CUSTNAME, C.EMAIL, C.DUTY
		, C.HOMADDR1 + C.HOMADDR2 + C.HOMADDR3 AS CUSTADDRESS
		, C.MOBILE1 + '-' + C.MOBILE2 + '-' + C.MOBILE3 AS MOBILE
		, D.BSNO, D.CORP_SN AS INCNO, D.MOBILE1 + '-' + D.MOBILE2 + '-' + D.MOBILE3 AS CLIMOBILE, D.PRSDNAME, D.HOMEPAGE
		, D.CLINO, D.CLINAME 
		,A.RCVNO, A.CLINO, A.CUSTNO, A.RCVTYPE
		, CASE WHEN A.RCVTYPE = 1 THEN '문의'
    		  WHEN A.RCVTYPE = 2 THEN '개선'
    		  WHEN A.RCVTYPE = 3 THEN '오류' END AS RCVTYPE_
    	, CONVERT(nvarchar,A.RCVDATE,23) AS RCVDATE
    	, A.RCVTIME, A.RCVCODE, A.RCVNAME
    	, CASE WHEN A.RCVCODE = 1 THEN '클라1'
    		  WHEN A.RCVCODE = 2 THEN '클라2'
    		  WHEN A.RCVCODE = 3 THEN '클라3' END AS RCVCODE_
    	, A.RCVDESC, A.RCVCHANNEL
    	, CASE WHEN A.RCVCHANNEL = 10 THEN '전화'
    		  WHEN A.RCVCHANNEL = 20 THEN 'SMS'
    		  WHEN A.RCVCHANNEL = 30 THEN '메일' END AS RCVCHANNEL_
    	, (SELECT USERNAME FROM Crud_SaaS.dbo.TB980010 WHERE USERNO = A.RCVOWNER) AS RCVOWNER_
    	, A.RCVOWNER, A.RCVOPINION
    	, CONVERT(varchar,B.RACTDATE,23) AS RACTDATE
    	, B.RACTTIME, B.RACTCODE
    	, CASE WHEN B.RACTCODE = 1 THEN 'option1'
    		  WHEN B.RACTCODE = 2 THEN 'option2'
    		  WHEN B.RACTCODE = 3 THEN 'option3' END AS RACTCODE_
    	, A.PRCSTATE
    	, CASE WHEN A.PRCSTATE = 1 THEN '접수'
    		   WHEN A.PRCSTATE = 2 THEN '처리'
    		   WHEN A.PRCSTATE = 3 THEN '이관' END AS PRCSTATE_
    	, B.RACTDESC, B.RACTOWNER
    	, (SELECT USERNAME FROM Crud_SaaS.dbo.TB980010 WHERE USERNO = B.RACTOWNER) AS RACTOWNER_
    	, A.ISDELETE
    	, CASE WHEN A.ISDELETE = 0 THEN '사용'
    		   WHEN A.ISDELETE = 1 THEN '미사용' END AS ISDELETE_
		FROM Crud_SaaS.dbo.T_RCV A
		LEFT OUTER JOIN (SELECT TOP 1 * FROM Crud_SaaS.dbo.T_RACT ORDER BY RACTNO DESC) B ON B.RCVNO = A.RCVNO 
		LEFT OUTER JOIN Crud_SaaS.dbo.CU100010 C ON C.CUSTNO = A.CUSTNO
		LEFT OUTER JOIN Crud_SaaS.dbo.TB200010 D ON D.CLINO = A.CLINO
		WHERE A.SITEID = #{siteid}
		AND A.RCVNO = #{rcvno}
	</select>
	
	<update id="totalUpdate" parameterType="hashMap">
		UPDATE Crud_SaaS.dbo.T_RCV
		SET CLINO = #{clino}
			, CUSTNO = #{custno}
			, RCVTYPE = #{rcvtype}
			, RCVDATE = #{rcvdate}
			, RCVTIME = #{rcvtime}
			, RCVCODE = #{rcvcode}
			, RCVNAME = #{rcvname}
			, RCVDESC = #{rcvdesc}
			, RCVCHANNEL = #{rcvchannel}
			, RCVOWNER = #{rcvowner}
			, RCVOPINION = #{rcvopinion}
			, PRCSTATE = #{prcstate}
			, EDTDATE = getDate()
			, EDTUSER = #{edtuser}
		WHERE SITEID = #{siteid}
		AND RCVNO = #{rcvno}
		
		UPDATE Crud_SaaS.dbo.T_RACT
		SET RACTDATE = #{ractdate}
			,RACTTIME = #{racttime}
			,RACTCODE = #{ractcode}
			,RACTOWNER = #{ractowner}
			,RACTDESC = #{ractdesc}
			,EDTDATE = getDate()
			,EDTUSER = #{edtuser}
		WHERE SITEID = #{siteid}
		AND RACTNO = #{ractno}
	</update>
	
	<update id="update" parameterType="hashMap">
	UPDATE Crud_SaaS.dbo.T_RACT
		SET RACTDATE = #{ractdate}
			,RACTTIME = #{racttime}
			,RACTCODE = #{ractcode}
			,RACTOWNER = #{ractowner}
			,RACTDESC = #{ractdesc}
			,EDTDATE = getDate()
			,EDTUSER = #{edtuser}
		WHERE SITEID = #{siteid}
		AND RACTNO = #{ractno}
	</update>
	
	<update id="svPrcState" parameterType="hashMap">
	
	UPDATE Crud_SaaS.dbo.T_RCV
		SET EDTDATE = getDate()
			EDTUSER = #{userno}
			PRCSTATE = #{prcstate}
		WHERE SITEID = #{siteid}
		AND RCVNO = #{rcvno}
	
	</update>
	
	<insert id="rcvinsert" parameterType="rcvDto">
		<selectKey keyProperty="rcvno"  resultType="integer" order="AFTER">
		INSERT INTO Crud_SaaS.dbo.T_RCV
		(
			CUSTNO
			, CLINO
			, RCVTYPE
			, RCVDATE
			, RCVTIME
			, RCVCODE
			, RCVNAME
			, RCVDESC
			, RCVCHANNEL
			, RCVOWNER
			, RCVOPINION
			, PRCSTATE
			, ISDELETE
			, SITEID
			, REGDATE
			, REGUSER
			, EDTDATE
			, EDTUSER
		)VALUES(
			#{custno}
			, #{clino}
			, #{rcvtype}
			, #{rcvdate}
			, #{rcvtime}
			, #{rcvcode}
			, #{rcvname}
			, #{rcvdesc}
			, #{rcvchannel}
			, #{rcvowner}
			, #{rcvopinion}
			, #{prcstate}
			, #{isdelete}
			, #{siteid}
			, getDate()
			, #{reguser}
			, getDate()
			, #{edtuser}
		)
		
		SELECT SCOPE_IDENTITY()
		</selectKey>
	</insert>
	
	<insert id="ractinsert" parameterType="hashMap">
		INSERT INTO Crud_SaaS.dbo.T_RACT
		(
			RCVNO
			, RACTDATE
			, RACTTIME
			, RACTCODE
			, RACTOWNER
			, RACTDESC
			, SITEID
			, ISDELETE
			, REGDATE
			, REGUSER
			, EDTDATE
			, EDTUSER
		)VALUES(
			#{rcvno}
			, #{ractdate}
			, #{racttime}
			, #{ractcode}
			, #{ractowner}
			, #{ractdesc}
			, #{siteid}
			, #{isdelete}
			, getDate()
			, #{reguser}
			, getDate()
			, #{edtuser}
		)
	</insert>
	
	<update id ="delete" parameterType="int">
		UPDATE Crud_SaaS.dbo.T_RCV
		SET ISDELETE = 1
		WHERE RCVNO = #{rcvno}
	</update>
	
	<select id="tabRact" parameterType="ractDto" resultType="HashMap">
		SELECT TOP 5
		CONVERT(nvarchar,A.RACTDATE,23) AS RACTDATE_
		,A.RACTTIME
		, CASE WHEN A.RACTCODE = 1 THEN 'option1'
    		   WHEN A.RACTCODE = 2 THEN 'option2'
    		   WHEN A.RACTCODE = 3 THEN 'option3' END AS RACTCODE_
    	,(SELECT USERNAME FROM Crud_SaaS.dbo.TB980010 WHERE USERNO = A.RACTOWNER)AS RACTOWNER_
    	,A.RACTDESC
    	FROM Crud_SaaS.dbo.T_RACT A
    	WHERE A.SITEID = #{siteid}
    	AND A.RCVNO = #{rcvno}
	</select>
	
	<insert id="conveyInsert" parameterType="conveyDto">
		INSERT T_CONVEY
			(RCVNO
			,PREVOWNER
			,NEXTOWNER
			,CONVEYREASON
			,CONVEYDATE
			,CONVEYDESC
			,REGDATE
			,REGUSER
			,EDTDATE
			,EDTUSER
			,SITEID
			)VALUES(
			#{rcvno}
			,#{prevowner}
			,#{nextowner}
			,#{conveyreason}
			,#{conveydate}
			,#{conveydesc}
			,getDate()
			,#{reguser}
			,getDate()
			,#{edtuser}
			,#{siteid}
			)
			
			UPDATE Crud_SaaS.dbo.T_RACT
			SET RACTOWNER = #{nextowner}
				,EDTDATE = getDate()
				,EDTUSER = #{edtuser}
			WHERE RCVNO = #{rcvno}
			AND SITEID = #{siteid}
			
			UPDATE Crud_SaaS.dbo.T_RCV
			SET PRCSTATE = 2
			WHERE RCVNO = #{rcvno}
			AND SITEID = #{siteid}
	</insert>
	
	<select id="tabConvey" parameterType="int" resultType="HashMap">
		SELECT A.CONVEYNO
			,A.RCVNO
			,A.PREVOWNER
			,(SELECT USERNAME FROM Crud_SaaS.dbo.TB980010 WHERE A.PREVOWNER = USERNO) AS PREVOWNER_
			,A.NEXTOWNER
			,(SELECT USERNAME FROM Crud_SaaS.dbo.TB980010 WHERE A.NEXTOWNER = USERNO) AS NEXTOWNER_
			,CASE WHEN A.CONVEYREASON = 1 THEN '업무변경'
				  WHEN A.CONVEYREASON = 2 THEN '휴가'
				  WHEN A.CONVEYREASON = 3 THEN '퇴사' END CONVEYREASON
			,CONVERT(nvarchar,A.CONVEYDATE,23) AS CONVEYDATE
			,A.CONVEYDESC
		FROM Crud_SaaS.dbo.T_CONVEY A
		WHERE A.RCVNO = #{rcvno}
		AND A.SITEID = #{siteid}
	</select>
	
</mapper>